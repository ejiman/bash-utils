#!/usr/bin/env bash
set -euo pipefail

# Resolve symlinks to get the actual script directory
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
LIB_DIR="$(cd "$SCRIPT_DIR/../lib" && pwd)"
source "$LIB_DIR/bootstrap.sh"

CLI_NAME="github-get-project-info"
CLI_VERSION="0.1.0"
CLI_DESCRIPTION="Get GitHub Project v2 information (project ID, item ID, field IDs) from an issue number"
CLI_USAGE="github-get-project-info [options] <issue-number>"

# ========= Argument definitions =========
arg_value OWNER -o --owner "Repository owner (auto-detected if in git repo)" "OWNER"
arg_value REPO -r --repo "Repository name (auto-detected if in git repo)" "REPO"
arg_value FORMAT -f --format "Output format: text or json (default: text)" "FORMAT"
arg_flag VERBOSE -V --verbose "Enable verbose output"

# ========= Parse arguments =========
parse_args "$@"

# ========= Validation =========
if [[ ${#POSITIONAL[@]} -ne 1 ]]; then
  die "Expected exactly 1 argument (issue number). Usage: $CLI_USAGE"
fi

ISSUE="${POSITIONAL[0]}"

# Validate that issue number is a positive integer
if ! [[ "$ISSUE" =~ ^[0-9]+$ ]]; then
  die "Issue number must be a positive integer: $ISSUE"
fi

# ========= Helper functions =========

# Detect repository owner and name from git remote
detect_repo_info() {
  if ! git rev-parse --git-dir &> /dev/null; then
    return 1
  fi

  local remote_url
  remote_url=$(git remote get-url origin 2> /dev/null || echo "")

  if [[ -z "$remote_url" ]]; then
    return 1
  fi

  # Parse GitHub URL (supports both HTTPS and SSH)
  # HTTPS: https://github.com/owner/repo.git
  # SSH: git@github.com:owner/repo.git
  if [[ "$remote_url" =~ github\.com[:/]([^/]+)/([^/\.]+)(\.git)?$ ]]; then
    echo "${BASH_REMATCH[1]} ${BASH_REMATCH[2]}"
    return 0
  fi

  return 1
}

# Fetch project info using GitHub GraphQL API
fetch_project_info() {
  local owner="$1"
  local repo="$2"
  local issue_num="$3"

  # shellcheck disable=SC2016
  local query='
    query($owner: String!, $repo: String!, $issueNumber: Int!) {
      repository(owner: $owner, name: $repo) {
        issue(number: $issueNumber) {
          title
          projectItems(first: 10) {
            nodes {
              id
              project {
                id
                title
                number
              }
              fieldValues(first: 50) {
                nodes {
                  ... on ProjectV2ItemFieldTextValue {
                    text
                    field {
                      ... on ProjectV2FieldCommon {
                        id
                        name
                      }
                    }
                  }
                  ... on ProjectV2ItemFieldSingleSelectValue {
                    name
                    field {
                      ... on ProjectV2FieldCommon {
                        id
                        name
                      }
                    }
                  }
                  ... on ProjectV2ItemFieldNumberValue {
                    number
                    field {
                      ... on ProjectV2FieldCommon {
                        id
                        name
                      }
                    }
                  }
                  ... on ProjectV2ItemFieldDateValue {
                    date
                    field {
                      ... on ProjectV2FieldCommon {
                        id
                        name
                      }
                    }
                  }
                  ... on ProjectV2ItemFieldIterationValue {
                    title
                    field {
                      ... on ProjectV2FieldCommon {
                        id
                        name
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  '

  gh api graphql \
    -f query="$query" \
    -f owner="$owner" \
    -f repo="$repo" \
    -F issueNumber="$issue_num"
}

# Format output as human-readable text
format_text() {
  local json="$1"
  local owner="$2"
  local repo="$3"
  local issue_num="$4"

  local issue_title
  issue_title=$(echo "$json" | jq -r '.data.repository.issue.title // "N/A"')

  echo "Repository: $owner/$repo"
  echo "Issue: #$issue_num - $issue_title"
  echo ""

  local project_count
  project_count=$(echo "$json" | jq -r '.data.repository.issue.projectItems.nodes | length')

  if [[ "$project_count" -eq 0 ]]; then
    echo "No projects found for this issue."
    return
  fi

  echo "Found $project_count project(s):"
  echo ""

  local idx=0
  while [[ $idx -lt $project_count ]]; do
    local project_id project_title project_num item_id
    project_id=$(echo "$json" | jq -r ".data.repository.issue.projectItems.nodes[$idx].project.id")
    project_title=$(echo "$json" | jq -r ".data.repository.issue.projectItems.nodes[$idx].project.title")
    project_num=$(echo "$json" | jq -r ".data.repository.issue.projectItems.nodes[$idx].project.number")
    item_id=$(echo "$json" | jq -r ".data.repository.issue.projectItems.nodes[$idx].id")

    echo "Project #$project_num: $project_title"
    echo "  Project ID: $project_id"
    echo "  Item ID: $item_id"
    echo ""

    # Display field values
    local field_count
    field_count=$(echo "$json" | jq -r ".data.repository.issue.projectItems.nodes[$idx].fieldValues.nodes | length")

    if [[ "$field_count" -gt 0 ]]; then
      echo "  Custom Fields:"
      local field_idx=0
      while [[ $field_idx -lt $field_count ]]; do
        local field_id field_name field_value
        field_id=$(echo "$json" | jq -r ".data.repository.issue.projectItems.nodes[$idx].fieldValues.nodes[$field_idx].field.id // empty")
        field_name=$(echo "$json" | jq -r ".data.repository.issue.projectItems.nodes[$idx].fieldValues.nodes[$field_idx].field.name // empty")

        # Get value based on field type
        local text number date iteration select_value
        text=$(echo "$json" | jq -r ".data.repository.issue.projectItems.nodes[$idx].fieldValues.nodes[$field_idx].text // empty")
        number=$(echo "$json" | jq -r ".data.repository.issue.projectItems.nodes[$idx].fieldValues.nodes[$field_idx].number // empty")
        date=$(echo "$json" | jq -r ".data.repository.issue.projectItems.nodes[$idx].fieldValues.nodes[$field_idx].date // empty")
        iteration=$(echo "$json" | jq -r ".data.repository.issue.projectItems.nodes[$idx].fieldValues.nodes[$field_idx].title // empty")
        select_value=$(echo "$json" | jq -r ".data.repository.issue.projectItems.nodes[$idx].fieldValues.nodes[$field_idx].name // empty")

        field_value="$text$number$date$iteration$select_value"

        if [[ -n "$field_id" && -n "$field_name" ]]; then
          echo "    - $field_name (ID: $field_id): $field_value"
        fi

        field_idx=$((field_idx + 1))
      done
    fi

    echo ""
    idx=$((idx + 1))
  done
}

# ========= Main function =========
main() {
  # Check if gh command is available
  require_cmd gh
  require_cmd jq

  # Detect repository info if not provided
  if [[ -z "${OWNER:-}" ]] || [[ -z "${REPO:-}" ]]; then
    [[ "${VERBOSE:-}" == true ]] && log_info "Auto-detecting repository information..."

    local detected_info
    if ! detected_info=$(detect_repo_info); then
      die "Failed to auto-detect repository. Please specify --owner and --repo"
    fi

    read -r detected_owner detected_repo <<< "$detected_info"

    OWNER="${OWNER:-$detected_owner}"
    REPO="${REPO:-$detected_repo}"
  fi

  # Validate inputs
  [[ -z "${OWNER:-}" ]] && die "Repository owner is required. Use --owner or run in a git repository"
  [[ -z "${REPO:-}" ]] && die "Repository name is required. Use --repo or run in a git repository"

  # Set default format
  FORMAT="${FORMAT:-text}"

  # Validate format
  if [[ "$FORMAT" != "text" && "$FORMAT" != "json" ]]; then
    die "Invalid format: $FORMAT. Must be 'text' or 'json'"
  fi

  [[ "${VERBOSE:-}" == true ]] && log_info "Fetching project info for $OWNER/$REPO #$ISSUE..."

  # Fetch project information
  local response
  if ! response=$(fetch_project_info "$OWNER" "$REPO" "$ISSUE"); then
    die "Failed to fetch project information. Make sure the issue exists and you have access."
  fi

  # Check for errors in response
  local errors
  errors=$(echo "$response" | jq -r '.errors // empty')
  if [[ -n "$errors" ]]; then
    log_error "GraphQL API returned errors:"
    echo "$errors" | jq -r '.[] | "  - \(.message)"' >&2

    # Check if error is related to missing scopes
    if echo "$errors" | grep -q "read:project"; then
      echo "" >&2
      log_error "Missing required scope: read:project"
      echo "  Please authenticate with the required scope:" >&2
      echo "    gh auth refresh -s read:project" >&2
      echo "" >&2
      echo "  Or login with scopes:" >&2
      echo "    gh auth login -s read:project" >&2
    fi

    exit 1
  fi

  # Output results
  if [[ "$FORMAT" == "json" ]]; then
    echo "$response" | jq .
  else
    format_text "$response" "$OWNER" "$REPO" "$ISSUE"
  fi
}

main
